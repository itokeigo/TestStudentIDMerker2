<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>学生証メーカー</title>

<style>
body { font-family: sans-serif; padding: 30px; }
.container { display: flex; gap: 30px; align-items: flex-start; }
canvas { border: 1px solid #333; }
input, select, button { width: 260px; margin-bottom: 10px; }
.small { font-size: 12px; color: #666; width: 260px; }
</style>
</head>
<body>

<h2>学生証作成</h2>

<div class="container">

  <!-- 左：完成プレビュー -->
  <canvas id="cardCanvas" width="600" height="350"></canvas>

  <!-- 右：入力 -->
  <div>
    <select id="template">
      <option value="red">赤テンプレ</option>
      <option value="blue">青テンプレ</option>
    </select>

    <input class="value" placeholder="学校名">
    <input class="value" placeholder="学科（任意）">
    <input class="value" placeholder="名前">
    <input class="value" type="date" title="生年月日">
    <input class="value" type="date" title="有効期限">

    <input type="file" id="photo" accept="image/*">

    <button id="sendBtn">Discordに送信</button>
    <div class="small">※Webhook URLを公開しないでください（第三者に悪用されます）</div>
  </div>

</div>

<script>
/** ★ 自分のWebhookに差し替え ★ */
const WEBHOOK_URL = "https://discord.com/api/webhooks/1467433717969584231/m-MnTavprILs6PC2iK_NMZFRyPG0-rmBlf0y5B4WrJI0gYoHjyJqtg_Y0TVMvCJYpTzU";

const canvas = document.getElementById("cardCanvas");
const ctx = canvas.getContext("2d");
const values = document.querySelectorAll(".value");

const templates = {
  red: "学生証_1.png",
  blue: "学生証_2.png"
};

function draw() {
  const template = document.getElementById("template").value;
  const img = new Image();
  img.src = templates[template];

  img.onload = () => {
    ctx.clearRect(0, 0, canvas.width, canvas.height);

    // ① テンプレ
    ctx.drawImage(img, 0, 0, 600, 350);

    // ② 文字（位置は必要なら調整してOK）
    ctx.fillStyle = "#000";
    ctx.font = "18px sans-serif";

    ctx.fillText(values[0].value || "学校名", 250, 120);
    ctx.fillText(values[1].value || "学科", 250, 150);
    ctx.fillText(values[2].value || "名前", 250, 180);
    ctx.fillText(values[3].value || "2000-01-01", 250, 210);
    ctx.fillText(values[4].value || "2030-03-31", 250, 240);

    // ③ 写真
    const file = document.getElementById("photo").files[0];
    if (file) {
      const p = new Image();
      p.src = URL.createObjectURL(file);
      p.onload = () => {
        // 写真位置（ここもテンプレに合わせて調整OK）
        ctx.drawImage(p, 40, 90, 120, 160);
      };
    }
  };
}

// 入力変更で再描画
document.querySelectorAll("input, select").forEach(e => {
  e.addEventListener("input", draw);
  e.addEventListener("change", draw);
});

// canvas → blob を await できる形に
function canvasToBlob(cnv, type="image/png", quality=0.92) {
  return new Promise((resolve) => {
    cnv.toBlob((blob) => resolve(blob), type, quality);
  });
}

document.getElementById("sendBtn").addEventListener("click", async () => {

  const school = values[0].value || "-";
  const department = values[1].value || "-";
  const name = values[2].value || "-";
  const birthday = values[3].value || "-";
  const expiry = values[4].value || "-";

  try {
    // ① 画像（合成済みCanvas）をPNGに
    const pngBlob = await canvasToBlob(canvas, "image/png");

    // ② Discordへ multipart/form-data で送る
    const formData = new FormData();

    const payload = {
      embeds: [{
        title: "学生証（架空）",
        color: 3447003,
        fields: [
          { name: "学校名", value: school, inline: false },
          { name: "学科", value: department, inline: false },
          { name: "名前", value: name, inline: false },
          { name: "生年月日", value: birthday, inline: true },
          { name: "有効期限", value: expiry, inline: true }
        ],
        image: { url: "attachment://card.png" }
      }]
    };

    formData.append("payload_json", JSON.stringify(payload));
    formData.append("files[0]", pngBlob, "card.png");

    const res = await fetch(WEBHOOK_URL, {
      method: "POST",
      body: formData
    });

    if (res.ok) {
      alert("Discordに送信しました！");
    } else {
      const text = await res.text().catch(() => "");
      alert("送信に失敗しました。\n" + res.status + " " + res.statusText + "\n" + text);
    }

  } catch (e) {
    alert("通信エラー：\n" + (e?.message || e));
  }
});

// 初期描画
draw();
</script>

</body>
</html>
